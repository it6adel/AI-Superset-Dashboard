{"ast":null,"code":"import { css as _css } from \"@emotion/react\"; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint camelcase: 0 */\nimport { Component } from 'react';\nimport rison from 'rison';\nimport { connect } from 'react-redux';\nimport { withRouter } from 'react-router-dom';\nimport { InfoTooltipWithTrigger } from '@superset-ui/chart-controls';\nimport { css, DatasourceType, isDefined, logging, styled, SupersetClient, t } from '@superset-ui/core';\nimport { Input } from 'src/components/Input';\nimport { Form, FormItem } from 'src/components/Form';\nimport Alert from 'src/components/Alert';\nimport Modal from 'src/components/Modal';\nimport { Radio } from 'src/components/Radio';\nimport Button from 'src/components/Button';\nimport { AsyncSelect } from 'src/components';\nimport Loading from 'src/components/Loading';\nimport { canUserEditDashboard } from 'src/dashboard/util/permissionUtils';\nimport { setSaveChartModalVisibility } from 'src/explore/actions/saveModalActions';\n// Session storage key for recent dashboard\nimport { jsx as _jsx, jsxs as _jsxs } from \"@emotion/react/jsx-runtime\";const SK_DASHBOARD_ID = 'save_chart_recent_dashboard';\nexport const StyledModal = styled(Modal)`\n  .antd5-modal-body {\n    overflow: visible;\n  }\n  i {\n    position: absolute;\n    top: -${({ theme }) => theme.gridUnit * 5.25}px;\n    left: ${({ theme }) => theme.gridUnit * 26.75}px;\n  }\n`;\nclass SaveModal extends Component {\n  constructor(props) {var _props$datasource;\n    super(props);this.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n    handleDatasetNameChange = (e) => {\n      // @ts-expect-error\n      this.setState({ datasetName: e.target.value });\n    };this.\n\n\n\n\n\n\n\n\n\n\n\n\n    handleRedirect = (windowLocationSearch, chart) => {\n      const searchParams = new URLSearchParams(windowLocationSearch);\n      searchParams.set('save_action', this.state.action);\n      if (this.state.action !== 'overwrite') {\n        searchParams.delete('form_data_key');\n      }\n      searchParams.set('slice_id', chart.id.toString());\n      return searchParams;\n    };this.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n    loadDashboard = async (id) => {\n      const response = await SupersetClient.get({\n        endpoint: `/api/v1/dashboard/${id}`\n      });\n      return response.json.result;\n    };this.\n    loadDashboards = async (search, page, pageSize) => {\n      const queryParams = rison.encode({\n        columns: ['id', 'dashboard_title'],\n        filters: [\n        {\n          col: 'dashboard_title',\n          opr: 'ct',\n          value: search\n        },\n        {\n          col: 'owners',\n          opr: 'rel_m_m',\n          value: this.props.user.userId\n        }],\n\n        page,\n        page_size: pageSize,\n        order_column: 'dashboard_title'\n      });\n      const { json } = await SupersetClient.get({\n        endpoint: `/api/v1/dashboard/?q=${queryParams}`\n      });\n      const { result, count } = json;\n      return {\n        data: result.map((dashboard) => ({\n          value: dashboard.id,\n          label: dashboard.dashboard_title\n        })),\n        totalCount: count\n      };\n    };this.\n    renderSaveChartModal = () => {var _this$props$datasourc;\n      const info = this.info();\n      return _jsxs(Form, { layout: \"vertical\", children: [\n        _jsxs(FormItem, { children: [\n          _jsx(Radio, { id: \"overwrite-radio\", disabled: !this.canOverwriteSlice(), checked: this.state.action === 'overwrite', onChange: () => this.changeAction('overwrite'), children:\n            t('Save (Overwrite)') }\n          ),\n          _jsx(Radio, { id: \"saveas-radio\", checked: this.state.action === 'saveas', onChange: () => this.changeAction('saveas'), children:\n            t('Save as...') }\n          )] }\n        ),\n        _jsx(\"hr\", {}),\n        _jsx(FormItem, { label: t('Chart name'), required: true, children:\n          _jsx(Input, { name: \"new_slice_name\", type: \"text\", placeholder: \"Name\", value: this.state.newSliceName, onChange: this.onSliceNameChange }) }\n        ),\n        ((_this$props$datasourc = this.props.datasource) == null ? void 0 : _this$props$datasourc.type) === 'query' && _jsxs(FormItem, { label: t('Dataset Name'), required: true, children: [\n          _jsx(InfoTooltipWithTrigger, { tooltip: t('A reusable dataset will be saved with your chart.'), placement: \"right\" }),\n          _jsx(Input, { name: \"dataset_name\", type: \"text\", placeholder: \"Dataset Name\", value: this.state.datasetName, onChange: this.handleDatasetNameChange })] }\n        ),\n        _jsx(FormItem, { label: t('Add to dashboard'), children:\n          _jsx(AsyncSelect, { allowClear: true, allowNewOptions: true, ariaLabel: t('Select a dashboard'), options: this.loadDashboards, onChange: this.onDashboardChange, value: this.state.dashboard, placeholder: _jsxs(\"div\", { children: [\n              _jsx(\"b\", { children: t('Select') }),\n              t(' a dashboard OR '),\n              _jsx(\"b\", { children: t('create') }),\n              t(' a new one')] }\n            ) }) }\n        ),\n        info && _jsx(Alert, { type: \"info\", message: info, closable: false }),\n        this.props.alert && _jsx(Alert, { css: /*#__PURE__*/_css({ marginTop: info ? 16 : undefined }, process.env.NODE_ENV === \"production\" ? \"\" : \";label:SaveModal;\", process.env.NODE_ENV === \"production\" ? \"\" : \"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2FkZWwvc3VwZXJzZXQvc3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9TYXZlTW9kYWwudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQW9ScUMiLCJmaWxlIjoiL2hvbWUvYWRlbC9zdXBlcnNldC9zdXBlcnNldC1mcm9udGVuZC9zcmMvZXhwbG9yZS9jb21wb25lbnRzL1NhdmVNb2RhbC50c3giLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbiAqIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuICogZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbiAqIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbiAqIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbiAqIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG4vKiBlc2xpbnQgY2FtZWxjYXNlOiAwICovXG5pbXBvcnQgeyBDb21wb25lbnQgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgcmlzb24gZnJvbSAncmlzb24nO1xuaW1wb3J0IHsgY29ubmVjdCB9IGZyb20gJ3JlYWN0LXJlZHV4JztcbmltcG9ydCB7IHdpdGhSb3V0ZXIgfSBmcm9tICdyZWFjdC1yb3V0ZXItZG9tJztcbmltcG9ydCB7IEluZm9Ub29sdGlwV2l0aFRyaWdnZXIgfSBmcm9tICdAc3VwZXJzZXQtdWkvY2hhcnQtY29udHJvbHMnO1xuaW1wb3J0IHsgY3NzLCBEYXRhc291cmNlVHlwZSwgaXNEZWZpbmVkLCBsb2dnaW5nLCBzdHlsZWQsIFN1cGVyc2V0Q2xpZW50LCB0LCB9IGZyb20gJ0BzdXBlcnNldC11aS9jb3JlJztcbmltcG9ydCB7IElucHV0IH0gZnJvbSAnc3JjL2NvbXBvbmVudHMvSW5wdXQnO1xuaW1wb3J0IHsgRm9ybSwgRm9ybUl0ZW0gfSBmcm9tICdzcmMvY29tcG9uZW50cy9Gb3JtJztcbmltcG9ydCBBbGVydCBmcm9tICdzcmMvY29tcG9uZW50cy9BbGVydCc7XG5pbXBvcnQgTW9kYWwgZnJvbSAnc3JjL2NvbXBvbmVudHMvTW9kYWwnO1xuaW1wb3J0IHsgUmFkaW8gfSBmcm9tICdzcmMvY29tcG9uZW50cy9SYWRpbyc7XG5pbXBvcnQgQnV0dG9uIGZyb20gJ3NyYy9jb21wb25lbnRzL0J1dHRvbic7XG5pbXBvcnQgeyBBc3luY1NlbGVjdCB9IGZyb20gJ3NyYy9jb21wb25lbnRzJztcbmltcG9ydCBMb2FkaW5nIGZyb20gJ3NyYy9jb21wb25lbnRzL0xvYWRpbmcnO1xuaW1wb3J0IHsgY2FuVXNlckVkaXREYXNoYm9hcmQgfSBmcm9tICdzcmMvZGFzaGJvYXJkL3V0aWwvcGVybWlzc2lvblV0aWxzJztcbmltcG9ydCB7IHNldFNhdmVDaGFydE1vZGFsVmlzaWJpbGl0eSB9IGZyb20gJ3NyYy9leHBsb3JlL2FjdGlvbnMvc2F2ZU1vZGFsQWN0aW9ucyc7XG4vLyBTZXNzaW9uIHN0b3JhZ2Uga2V5IGZvciByZWNlbnQgZGFzaGJvYXJkXG5jb25zdCBTS19EQVNIQk9BUkRfSUQgPSAnc2F2ZV9jaGFydF9yZWNlbnRfZGFzaGJvYXJkJztcbmV4cG9ydCBjb25zdCBTdHlsZWRNb2RhbCA9IHN0eWxlZChNb2RhbCkgYFxuICAuYW50ZDUtbW9kYWwtYm9keSB7XG4gICAgb3ZlcmZsb3c6IHZpc2libGU7XG4gIH1cbiAgaSB7XG4gICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgIHRvcDogLSR7KHsgdGhlbWUgfSkgPT4gdGhlbWUuZ3JpZFVuaXQgKiA1LjI1fXB4O1xuICAgIGxlZnQ6ICR7KHsgdGhlbWUgfSkgPT4gdGhlbWUuZ3JpZFVuaXQgKiAyNi43NX1weDtcbiAgfVxuYDtcbmNsYXNzIFNhdmVNb2RhbCBleHRlbmRzIENvbXBvbmVudCB7XG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgbmV3U2xpY2VOYW1lOiBwcm9wcy5zbGljZU5hbWUsXG4gICAgICAgICAgICBkYXRhc2V0TmFtZTogcHJvcHMuZGF0YXNvdXJjZT8ubmFtZSxcbiAgICAgICAgICAgIGFjdGlvbjogdGhpcy5jYW5PdmVyd3JpdGVTbGljZSgpID8gJ292ZXJ3cml0ZScgOiAnc2F2ZWFzJyxcbiAgICAgICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICBkYXNoYm9hcmQ6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vbkRhc2hib2FyZENoYW5nZSA9IHRoaXMub25EYXNoYm9hcmRDaGFuZ2UuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5vblNsaWNlTmFtZUNoYW5nZSA9IHRoaXMub25TbGljZU5hbWVDaGFuZ2UuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VBY3Rpb24gPSB0aGlzLmNoYW5nZUFjdGlvbi5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLnNhdmVPck92ZXJ3cml0ZSA9IHRoaXMuc2F2ZU9yT3ZlcndyaXRlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuaXNOZXdEYXNoYm9hcmQgPSB0aGlzLmlzTmV3RGFzaGJvYXJkLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMub25IaWRlID0gdGhpcy5vbkhpZGUuYmluZCh0aGlzKTtcbiAgICB9XG4gICAgaXNOZXdEYXNoYm9hcmQoKSB7XG4gICAgICAgIGNvbnN0IHsgZGFzaGJvYXJkIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICByZXR1cm4gdHlwZW9mIGRhc2hib2FyZD8udmFsdWUgPT09ICdzdHJpbmcnO1xuICAgIH1cbiAgICBjYW5PdmVyd3JpdGVTbGljZSgpIHtcbiAgICAgICAgcmV0dXJuICh0aGlzLnByb3BzLnNsaWNlPy5vd25lcnM/LmluY2x1ZGVzKHRoaXMucHJvcHMudXNlci51c2VySWQpICYmXG4gICAgICAgICAgICAhdGhpcy5wcm9wcy5zbGljZT8uaXNfbWFuYWdlZF9leHRlcm5hbGx5KTtcbiAgICB9XG4gICAgYXN5bmMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGxldCB7IGRhc2hib2FyZElkIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAoIWRhc2hib2FyZElkKSB7XG4gICAgICAgICAgICBsZXQgbGFzdERhc2hib2FyZCA9IG51bGw7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGxhc3REYXNoYm9hcmQgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFNLX0RBU0hCT0FSRF9JRCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAvLyBjb250aW51ZSByZWdhcmRsZXNzIG9mIGVycm9yXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkYXNoYm9hcmRJZCA9IGxhc3REYXNoYm9hcmQgJiYgcGFyc2VJbnQobGFzdERhc2hib2FyZCwgMTApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXNoYm9hcmRJZCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSAoYXdhaXQgdGhpcy5sb2FkRGFzaGJvYXJkKGRhc2hib2FyZElkKSk7XG4gICAgICAgICAgICAgICAgaWYgKGNhblVzZXJFZGl0RGFzaGJvYXJkKHJlc3VsdCwgdGhpcy5wcm9wcy51c2VyKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hib2FyZDogeyBsYWJlbDogcmVzdWx0LmRhc2hib2FyZF90aXRsZSwgdmFsdWU6IHJlc3VsdC5pZCB9LFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBsb2dnaW5nLndhcm4oZXJyb3IpO1xuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMuYWRkRGFuZ2VyVG9hc3QodCgnQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgbG9hZGluZyBkYXNoYm9hcmQgaW5mb3JtYXRpb24uJykpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGhhbmRsZURhdGFzZXROYW1lQ2hhbmdlID0gKGUpID0+IHtcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgZGF0YXNldE5hbWU6IGUudGFyZ2V0LnZhbHVlIH0pO1xuICAgIH07XG4gICAgb25TbGljZU5hbWVDaGFuZ2UoZXZlbnQpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG5ld1NsaWNlTmFtZTogZXZlbnQudGFyZ2V0LnZhbHVlIH0pO1xuICAgIH1cbiAgICBvbkRhc2hib2FyZENoYW5nZShkYXNoYm9hcmQpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGRhc2hib2FyZCB9KTtcbiAgICB9XG4gICAgY2hhbmdlQWN0aW9uKGFjdGlvbikge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgYWN0aW9uIH0pO1xuICAgIH1cbiAgICBvbkhpZGUoKSB7XG4gICAgICAgIHRoaXMucHJvcHMuZGlzcGF0Y2goc2V0U2F2ZUNoYXJ0TW9kYWxWaXNpYmlsaXR5KGZhbHNlKSk7XG4gICAgfVxuICAgIGhhbmRsZVJlZGlyZWN0ID0gKHdpbmRvd0xvY2F0aW9uU2VhcmNoLCBjaGFydCkgPT4ge1xuICAgICAgICBjb25zdCBzZWFyY2hQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvd0xvY2F0aW9uU2VhcmNoKTtcbiAgICAgICAgc2VhcmNoUGFyYW1zLnNldCgnc2F2ZV9hY3Rpb24nLCB0aGlzLnN0YXRlLmFjdGlvbik7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmFjdGlvbiAhPT0gJ292ZXJ3cml0ZScpIHtcbiAgICAgICAgICAgIHNlYXJjaFBhcmFtcy5kZWxldGUoJ2Zvcm1fZGF0YV9rZXknKTtcbiAgICAgICAgfVxuICAgICAgICBzZWFyY2hQYXJhbXMuc2V0KCdzbGljZV9pZCcsIGNoYXJ0LmlkLnRvU3RyaW5nKCkpO1xuICAgICAgICByZXR1cm4gc2VhcmNoUGFyYW1zO1xuICAgIH07XG4gICAgYXN5bmMgc2F2ZU9yT3ZlcndyaXRlKGdvdG9kYXNoKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBpc0xvYWRpbmc6IHRydWUgfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5kYXRhc291cmNlPy50eXBlID09PSBEYXRhc291cmNlVHlwZS5RdWVyeSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgc2NoZW1hLCBzcWwsIGRhdGFiYXNlIH0gPSB0aGlzLnByb3BzLmRhdGFzb3VyY2U7XG4gICAgICAgICAgICAgICAgY29uc3QgeyB0ZW1wbGF0ZVBhcmFtcyB9ID0gdGhpcy5wcm9wcy5kYXRhc291cmNlO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucHJvcHMuYWN0aW9ucy5zYXZlRGF0YXNldCh7XG4gICAgICAgICAgICAgICAgICAgIHNjaGVtYSxcbiAgICAgICAgICAgICAgICAgICAgc3FsLFxuICAgICAgICAgICAgICAgICAgICBkYXRhYmFzZSxcbiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVQYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgIGRhdGFzb3VyY2VOYW1lOiB0aGlzLnN0YXRlLmRhdGFzZXROYW1lLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gIEdldCBjaGFydCBkYXNoYm9hcmRzXG4gICAgICAgICAgICBsZXQgc2xpY2VEYXNoYm9hcmRzID0gW107XG4gICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5zbGljZSAmJiB0aGlzLnN0YXRlLmFjdGlvbiA9PT0gJ292ZXJ3cml0ZScpIHtcbiAgICAgICAgICAgICAgICBzbGljZURhc2hib2FyZHMgPSBhd2FpdCB0aGlzLnByb3BzLmFjdGlvbnMuZ2V0U2xpY2VEYXNoYm9hcmRzKHRoaXMucHJvcHMuc2xpY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSB0aGlzLnByb3BzLmZvcm1fZGF0YSB8fCB7fTtcbiAgICAgICAgICAgIGRlbGV0ZSBmb3JtRGF0YS51cmxfcGFyYW1zO1xuICAgICAgICAgICAgbGV0IGRhc2hib2FyZCA9IG51bGw7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5kYXNoYm9hcmQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdmFsaWRJZCA9IHRoaXMuc3RhdGUuZGFzaGJvYXJkLnZhbHVlO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzTmV3RGFzaGJvYXJkKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnByb3BzLmFjdGlvbnMuY3JlYXRlRGFzaGJvYXJkKHRoaXMuc3RhdGUuZGFzaGJvYXJkLmxhYmVsKTtcbiAgICAgICAgICAgICAgICAgICAgdmFsaWRJZCA9IHJlc3BvbnNlLmlkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBkYXNoYm9hcmQgPSBhd2FpdCB0aGlzLmxvYWREYXNoYm9hcmQodmFsaWRJZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3BzLmFjdGlvbnMuc2F2ZVNsaWNlRmFpbGVkKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChkYXNoYm9hcmQpICYmIGlzRGVmaW5lZChkYXNoYm9hcmQ/LmlkKSkge1xuICAgICAgICAgICAgICAgICAgICBzbGljZURhc2hib2FyZHMgPSBzbGljZURhc2hib2FyZHMuaW5jbHVkZXMoZGFzaGJvYXJkLmlkKVxuICAgICAgICAgICAgICAgICAgICAgICAgPyBzbGljZURhc2hib2FyZHNcbiAgICAgICAgICAgICAgICAgICAgICAgIDogWy4uLnNsaWNlRGFzaGJvYXJkcywgZGFzaGJvYXJkLmlkXTtcbiAgICAgICAgICAgICAgICAgICAgZm9ybURhdGEuZGFzaGJvYXJkcyA9IHNsaWNlRGFzaGJvYXJkcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBTZXRzIHRoZSBmb3JtIGRhdGFcbiAgICAgICAgICAgIHRoaXMucHJvcHMuYWN0aW9ucy5zZXRGb3JtRGF0YSh7IC4uLmZvcm1EYXRhIH0pO1xuICAgICAgICAgICAgLy8gIFVwZGF0ZSBvciBjcmVhdGUgc2xpY2VcbiAgICAgICAgICAgIGxldCB2YWx1ZTtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLmFjdGlvbiA9PT0gJ292ZXJ3cml0ZScpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGF3YWl0IHRoaXMucHJvcHMuYWN0aW9ucy51cGRhdGVTbGljZSh0aGlzLnByb3BzLnNsaWNlLCB0aGlzLnN0YXRlLm5ld1NsaWNlTmFtZSwgc2xpY2VEYXNoYm9hcmRzLCBkYXNoYm9hcmRcbiAgICAgICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogZGFzaGJvYXJkLmRhc2hib2FyZF90aXRsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldzogdGhpcy5pc05ld0Rhc2hib2FyZCgpLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIDogbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGF3YWl0IHRoaXMucHJvcHMuYWN0aW9ucy5jcmVhdGVTbGljZSh0aGlzLnN0YXRlLm5ld1NsaWNlTmFtZSwgc2xpY2VEYXNoYm9hcmRzLCBkYXNoYm9hcmRcbiAgICAgICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogZGFzaGJvYXJkLmRhc2hib2FyZF90aXRsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldzogdGhpcy5pc05ld0Rhc2hib2FyZCgpLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIDogbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGlmIChkYXNoYm9hcmQpIHtcbiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShTS19EQVNIQk9BUkRfSUQsIGAke2Rhc2hib2FyZC5pZH1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oU0tfREFTSEJPQVJEX0lEKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAvLyBjb250aW51ZSByZWdhcmRsZXNzIG9mIGVycm9yXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBHbyB0byBuZXcgZGFzaGJvYXJkIHVybFxuICAgICAgICAgICAgaWYgKGdvdG9kYXNoICYmIGRhc2hib2FyZCkge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMuaGlzdG9yeS5wdXNoKGRhc2hib2FyZC51cmwpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaFBhcmFtcyA9IHRoaXMuaGFuZGxlUmVkaXJlY3Qod2luZG93LmxvY2F0aW9uLnNlYXJjaCwgdmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5oaXN0b3J5LnJlcGxhY2UoYC9leHBsb3JlLz8ke3NlYXJjaFBhcmFtcy50b1N0cmluZygpfWApO1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGlzTG9hZGluZzogZmFsc2UgfSk7XG4gICAgICAgICAgICB0aGlzLm9uSGlkZSgpO1xuICAgICAgICB9XG4gICAgICAgIGZpbmFsbHkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGlzTG9hZGluZzogZmFsc2UgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgbG9hZERhc2hib2FyZCA9IGFzeW5jIChpZCkgPT4ge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFN1cGVyc2V0Q2xpZW50LmdldCh7XG4gICAgICAgICAgICBlbmRwb2ludDogYC9hcGkvdjEvZGFzaGJvYXJkLyR7aWR9YCxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5qc29uLnJlc3VsdDtcbiAgICB9O1xuICAgIGxvYWREYXNoYm9hcmRzID0gYXN5bmMgKHNlYXJjaCwgcGFnZSwgcGFnZVNpemUpID0+IHtcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSByaXNvbi5lbmNvZGUoe1xuICAgICAgICAgICAgY29sdW1uczogWydpZCcsICdkYXNoYm9hcmRfdGl0bGUnXSxcbiAgICAgICAgICAgIGZpbHRlcnM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGNvbDogJ2Rhc2hib2FyZF90aXRsZScsXG4gICAgICAgICAgICAgICAgICAgIG9wcjogJ2N0JyxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHNlYXJjaCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgY29sOiAnb3duZXJzJyxcbiAgICAgICAgICAgICAgICAgICAgb3ByOiAncmVsX21fbScsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLnByb3BzLnVzZXIudXNlcklkLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcGFnZSxcbiAgICAgICAgICAgIHBhZ2Vfc2l6ZTogcGFnZVNpemUsXG4gICAgICAgICAgICBvcmRlcl9jb2x1bW46ICdkYXNoYm9hcmRfdGl0bGUnLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgeyBqc29uIH0gPSBhd2FpdCBTdXBlcnNldENsaWVudC5nZXQoe1xuICAgICAgICAgICAgZW5kcG9pbnQ6IGAvYXBpL3YxL2Rhc2hib2FyZC8/cT0ke3F1ZXJ5UGFyYW1zfWAsXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB7IHJlc3VsdCwgY291bnQgfSA9IGpzb247XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkYXRhOiByZXN1bHQubWFwKChkYXNoYm9hcmQpID0+ICh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGRhc2hib2FyZC5pZCxcbiAgICAgICAgICAgICAgICBsYWJlbDogZGFzaGJvYXJkLmRhc2hib2FyZF90aXRsZSxcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgIHRvdGFsQ291bnQ6IGNvdW50LFxuICAgICAgICB9O1xuICAgIH07XG4gICAgcmVuZGVyU2F2ZUNoYXJ0TW9kYWwgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGluZm8gPSB0aGlzLmluZm8oKTtcbiAgICAgICAgcmV0dXJuICg8Rm9ybSBkYXRhLXRlc3Q9XCJzYXZlLW1vZGFsLWJvZHlcIiBsYXlvdXQ9XCJ2ZXJ0aWNhbFwiPlxuICAgICAgICA8Rm9ybUl0ZW0gZGF0YS10ZXN0PVwicmFkaW8tZ3JvdXBcIj5cbiAgICAgICAgICA8UmFkaW8gaWQ9XCJvdmVyd3JpdGUtcmFkaW9cIiBkaXNhYmxlZD17IXRoaXMuY2FuT3ZlcndyaXRlU2xpY2UoKX0gY2hlY2tlZD17dGhpcy5zdGF0ZS5hY3Rpb24gPT09ICdvdmVyd3JpdGUnfSBvbkNoYW5nZT17KCkgPT4gdGhpcy5jaGFuZ2VBY3Rpb24oJ292ZXJ3cml0ZScpfSBkYXRhLXRlc3Q9XCJzYXZlLW92ZXJ3cml0ZS1yYWRpb1wiPlxuICAgICAgICAgICAge3QoJ1NhdmUgKE92ZXJ3cml0ZSknKX1cbiAgICAgICAgICA8L1JhZGlvPlxuICAgICAgICAgIDxSYWRpbyBpZD1cInNhdmVhcy1yYWRpb1wiIGRhdGEtdGVzdD1cInNhdmVhcy1yYWRpb1wiIGNoZWNrZWQ9e3RoaXMuc3RhdGUuYWN0aW9uID09PSAnc2F2ZWFzJ30gb25DaGFuZ2U9eygpID0+IHRoaXMuY2hhbmdlQWN0aW9uKCdzYXZlYXMnKX0+XG4gICAgICAgICAgICB7dCgnU2F2ZSBhcy4uLicpfVxuICAgICAgICAgIDwvUmFkaW8+XG4gICAgICAgIDwvRm9ybUl0ZW0+XG4gICAgICAgIDxociAvPlxuICAgICAgICA8Rm9ybUl0ZW0gbGFiZWw9e3QoJ0NoYXJ0IG5hbWUnKX0gcmVxdWlyZWQ+XG4gICAgICAgICAgPElucHV0IG5hbWU9XCJuZXdfc2xpY2VfbmFtZVwiIHR5cGU9XCJ0ZXh0XCIgcGxhY2Vob2xkZXI9XCJOYW1lXCIgdmFsdWU9e3RoaXMuc3RhdGUubmV3U2xpY2VOYW1lfSBvbkNoYW5nZT17dGhpcy5vblNsaWNlTmFtZUNoYW5nZX0gZGF0YS10ZXN0PVwibmV3LWNoYXJ0LW5hbWVcIi8+XG4gICAgICAgIDwvRm9ybUl0ZW0+XG4gICAgICAgIHt0aGlzLnByb3BzLmRhdGFzb3VyY2U/LnR5cGUgPT09ICdxdWVyeScgJiYgKDxGb3JtSXRlbSBsYWJlbD17dCgnRGF0YXNldCBOYW1lJyl9IHJlcXVpcmVkPlxuICAgICAgICAgICAgPEluZm9Ub29sdGlwV2l0aFRyaWdnZXIgdG9vbHRpcD17dCgnQSByZXVzYWJsZSBkYXRhc2V0IHdpbGwgYmUgc2F2ZWQgd2l0aCB5b3VyIGNoYXJ0LicpfSBwbGFjZW1lbnQ9XCJyaWdodFwiLz5cbiAgICAgICAgICAgIDxJbnB1dCBuYW1lPVwiZGF0YXNldF9uYW1lXCIgdHlwZT1cInRleHRcIiBwbGFjZWhvbGRlcj1cIkRhdGFzZXQgTmFtZVwiIHZhbHVlPXt0aGlzLnN0YXRlLmRhdGFzZXROYW1lfSBvbkNoYW5nZT17dGhpcy5oYW5kbGVEYXRhc2V0TmFtZUNoYW5nZX0gZGF0YS10ZXN0PVwibmV3LWRhdGFzZXQtbmFtZVwiLz5cbiAgICAgICAgICA8L0Zvcm1JdGVtPil9XG4gICAgICAgIDxGb3JtSXRlbSBsYWJlbD17dCgnQWRkIHRvIGRhc2hib2FyZCcpfSBkYXRhLXRlc3Q9XCJzYXZlLWNoYXJ0LW1vZGFsLXNlbGVjdC1kYXNoYm9hcmQtZm9ybVwiPlxuICAgICAgICAgIDxBc3luY1NlbGVjdCBhbGxvd0NsZWFyIGFsbG93TmV3T3B0aW9ucyBhcmlhTGFiZWw9e3QoJ1NlbGVjdCBhIGRhc2hib2FyZCcpfSBvcHRpb25zPXt0aGlzLmxvYWREYXNoYm9hcmRzfSBvbkNoYW5nZT17dGhpcy5vbkRhc2hib2FyZENoYW5nZX0gdmFsdWU9e3RoaXMuc3RhdGUuZGFzaGJvYXJkfSBwbGFjZWhvbGRlcj17PGRpdj5cbiAgICAgICAgICAgICAgICA8Yj57dCgnU2VsZWN0Jyl9PC9iPlxuICAgICAgICAgICAgICAgIHt0KCcgYSBkYXNoYm9hcmQgT1IgJyl9XG4gICAgICAgICAgICAgICAgPGI+e3QoJ2NyZWF0ZScpfTwvYj5cbiAgICAgICAgICAgICAgICB7dCgnIGEgbmV3IG9uZScpfVxuICAgICAgICAgICAgICA8L2Rpdj59Lz5cbiAgICAgICAgPC9Gb3JtSXRlbT5cbiAgICAgICAge2luZm8gJiYgPEFsZXJ0IHR5cGU9XCJpbmZvXCIgbWVzc2FnZT17aW5mb30gY2xvc2FibGU9e2ZhbHNlfS8+fVxuICAgICAgICB7dGhpcy5wcm9wcy5hbGVydCAmJiAoPEFsZXJ0IGNzcz17eyBtYXJnaW5Ub3A6IGluZm8gPyAxNiA6IHVuZGVmaW5lZCB9fSB0eXBlPVwid2FybmluZ1wiIG1lc3NhZ2U9e3RoaXMucHJvcHMuYWxlcnR9IGNsb3NhYmxlPXtmYWxzZX0vPil9XG4gICAgICA8L0Zvcm0+KTtcbiAgICB9O1xuICAgIGluZm8gPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGlzTmV3RGFzaGJvYXJkID0gdGhpcy5pc05ld0Rhc2hib2FyZCgpO1xuICAgICAgICBsZXQgY2hhcnRXaWxsQmVDcmVhdGVkID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnNsaWNlICYmXG4gICAgICAgICAgICAodGhpcy5zdGF0ZS5hY3Rpb24gIT09ICdvdmVyd3JpdGUnIHx8ICF0aGlzLmNhbk92ZXJ3cml0ZVNsaWNlKCkpKSB7XG4gICAgICAgICAgICBjaGFydFdpbGxCZUNyZWF0ZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFydFdpbGxCZUNyZWF0ZWQgJiYgaXNOZXdEYXNoYm9hcmQpIHtcbiAgICAgICAgICAgIHJldHVybiB0KCdBIG5ldyBjaGFydCBhbmQgZGFzaGJvYXJkIHdpbGwgYmUgY3JlYXRlZC4nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2hhcnRXaWxsQmVDcmVhdGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gdCgnQSBuZXcgY2hhcnQgd2lsbCBiZSBjcmVhdGVkLicpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc05ld0Rhc2hib2FyZCkge1xuICAgICAgICAgICAgcmV0dXJuIHQoJ0EgbmV3IGRhc2hib2FyZCB3aWxsIGJlIGNyZWF0ZWQuJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfTtcbiAgICByZW5kZXJGb290ZXIgPSAoKSA9PiAoPGRpdiBkYXRhLXRlc3Q9XCJzYXZlLW1vZGFsLWZvb3RlclwiPlxuICAgICAgPEJ1dHRvbiBpZD1cImJ0bl9jYW5jZWxcIiBidXR0b25TaXplPVwic21hbGxcIiBvbkNsaWNrPXt0aGlzLm9uSGlkZX0+XG4gICAgICAgIHt0KCdDYW5jZWwnKX1cbiAgICAgIDwvQnV0dG9uPlxuICAgICAgPEJ1dHRvbiBpZD1cImJ0bl9tb2RhbF9zYXZlX2dvdG9fZGFzaFwiIGJ1dHRvblNpemU9XCJzbWFsbFwiIGRpc2FibGVkPXshdGhpcy5zdGF0ZS5uZXdTbGljZU5hbWUgfHxcbiAgICAgICAgICAgICF0aGlzLnN0YXRlLmRhc2hib2FyZCB8fFxuICAgICAgICAgICAgKHRoaXMucHJvcHMuZGF0YXNvdXJjZT8udHlwZSAhPT0gRGF0YXNvdXJjZVR5cGUuVGFibGUgJiZcbiAgICAgICAgICAgICAgICAhdGhpcy5zdGF0ZS5kYXRhc2V0TmFtZSl9IG9uQ2xpY2s9eygpID0+IHRoaXMuc2F2ZU9yT3ZlcndyaXRlKHRydWUpfT5cbiAgICAgICAge3QoJ1NhdmUgJiBnbyB0byBkYXNoYm9hcmQnKX1cbiAgICAgIDwvQnV0dG9uPlxuICAgICAgPEJ1dHRvbiBpZD1cImJ0bl9tb2RhbF9zYXZlXCIgYnV0dG9uU2l6ZT1cInNtYWxsXCIgYnV0dG9uU3R5bGU9XCJwcmltYXJ5XCIgb25DbGljaz17KCkgPT4gdGhpcy5zYXZlT3JPdmVyd3JpdGUoZmFsc2UpfSBkaXNhYmxlZD17dGhpcy5zdGF0ZS5pc0xvYWRpbmcgfHxcbiAgICAgICAgICAgICF0aGlzLnN0YXRlLm5ld1NsaWNlTmFtZSB8fFxuICAgICAgICAgICAgKHRoaXMucHJvcHMuZGF0YXNvdXJjZT8udHlwZSAhPT0gRGF0YXNvdXJjZVR5cGUuVGFibGUgJiZcbiAgICAgICAgICAgICAgICAhdGhpcy5zdGF0ZS5kYXRhc2V0TmFtZSl9IGRhdGEtdGVzdD1cImJ0bi1tb2RhbC1zYXZlXCI+XG4gICAgICAgIHt0KCdTYXZlJyl9XG4gICAgICA8L0J1dHRvbj5cbiAgICA8L2Rpdj4pO1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgcmV0dXJuICg8U3R5bGVkTW9kYWwgc2hvdz17dGhpcy5wcm9wcy5pc1Zpc2libGV9IG9uSGlkZT17dGhpcy5vbkhpZGV9IHRpdGxlPXt0KCdTYXZlIGNoYXJ0Jyl9IGZvb3Rlcj17dGhpcy5yZW5kZXJGb290ZXIoKX0+XG4gICAgICAgIHt0aGlzLnN0YXRlLmlzTG9hZGluZyA/ICg8ZGl2IGNzcz17Y3NzIGBcbiAgICAgICAgICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG4gICAgICAgICAgICBgfT5cbiAgICAgICAgICAgIDxMb2FkaW5nIHBvc2l0aW9uPVwibm9ybWFsXCIvPlxuICAgICAgICAgIDwvZGl2PikgOiAodGhpcy5yZW5kZXJTYXZlQ2hhcnRNb2RhbCgpKX1cbiAgICAgIDwvU3R5bGVkTW9kYWw+KTtcbiAgICB9XG59XG5mdW5jdGlvbiBtYXBTdGF0ZVRvUHJvcHMoeyBleHBsb3JlLCBzYXZlTW9kYWwsIHVzZXIsIH0pIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBkYXRhc291cmNlOiBleHBsb3JlLmRhdGFzb3VyY2UsXG4gICAgICAgIHNsaWNlOiBleHBsb3JlLnNsaWNlLFxuICAgICAgICB1c2VyLFxuICAgICAgICBkYXNoYm9hcmRzOiBzYXZlTW9kYWwuZGFzaGJvYXJkcyxcbiAgICAgICAgYWxlcnQ6IHNhdmVNb2RhbC5zYXZlTW9kYWxBbGVydCxcbiAgICAgICAgaXNWaXNpYmxlOiBzYXZlTW9kYWwuaXNWaXNpYmxlLFxuICAgIH07XG59XG5leHBvcnQgZGVmYXVsdCB3aXRoUm91dGVyKGNvbm5lY3QobWFwU3RhdGVUb1Byb3BzKShTYXZlTW9kYWwpKTtcbi8vIFVzZXIgZm9yIHRlc3RpbmcgcHVycG9zZXMgbmVlZCB0byByZXZpc2l0IG9uY2Ugd2UgY29udmVydCB0aGlzIHRvIGZ1bmN0aW9uYWwgY29tcG9uZW50XG5leHBvcnQgeyBTYXZlTW9kYWwgYXMgUHVyZVNhdmVNb2RhbCB9O1xuIl19 */\"), type: \"warning\", message: this.props.alert, closable: false })] }\n      );\n    };this.\n    info = () => {\n      const isNewDashboard = this.isNewDashboard();\n      let chartWillBeCreated = false;\n      if (this.props.slice && (\n      this.state.action !== 'overwrite' || !this.canOverwriteSlice())) {\n        chartWillBeCreated = true;\n      }\n      if (chartWillBeCreated && isNewDashboard) {\n        return t('A new chart and dashboard will be created.');\n      }\n      if (chartWillBeCreated) {\n        return t('A new chart will be created.');\n      }\n      if (isNewDashboard) {\n        return t('A new dashboard will be created.');\n      }\n      return null;\n    };this.\n    renderFooter = () => {var _this$props$datasourc2, _this$props$datasourc3;return _jsxs(\"div\", { children: [\n        _jsx(Button, { id: \"btn_cancel\", buttonSize: \"small\", onClick: this.onHide, children:\n          t('Cancel') }\n        ),\n        _jsx(Button, { id: \"btn_modal_save_goto_dash\", buttonSize: \"small\", disabled: !this.state.newSliceName ||\n          !this.state.dashboard ||\n          ((_this$props$datasourc2 = this.props.datasource) == null ? void 0 : _this$props$datasourc2.type) !== DatasourceType.Table &&\n          !this.state.datasetName, onClick: () => this.saveOrOverwrite(true), children:\n          t('Save & go to dashboard') }\n        ),\n        _jsx(Button, { id: \"btn_modal_save\", buttonSize: \"small\", buttonStyle: \"primary\", onClick: () => this.saveOrOverwrite(false), disabled: this.state.isLoading ||\n          !this.state.newSliceName ||\n          ((_this$props$datasourc3 = this.props.datasource) == null ? void 0 : _this$props$datasourc3.type) !== DatasourceType.Table &&\n          !this.state.datasetName, children:\n          t('Save') }\n        )] }\n      );};this.state = { newSliceName: props.sliceName, datasetName: (_props$datasource = props.datasource) == null ? void 0 : _props$datasource.name, action: this.canOverwriteSlice() ? 'overwrite' : 'saveas', isLoading: false, dashboard: undefined };this.onDashboardChange = this.onDashboardChange.bind(this);this.onSliceNameChange = this.onSliceNameChange.bind(this);this.changeAction = this.changeAction.bind(this);this.saveOrOverwrite = this.saveOrOverwrite.bind(this);this.isNewDashboard = this.isNewDashboard.bind(this);this.onHide = this.onHide.bind(this);}isNewDashboard() {const { dashboard } = this.state;return typeof (dashboard == null ? void 0 : dashboard.value) === 'string';}canOverwriteSlice() {var _this$props$slice, _this$props$slice$own, _this$props$slice2;return ((_this$props$slice = this.props.slice) == null ? void 0 : (_this$props$slice$own = _this$props$slice.owners) == null ? void 0 : _this$props$slice$own.includes(this.props.user.userId)) && !((_this$props$slice2 = this.props.slice) != null && _this$props$slice2.is_managed_externally);}async componentDidMount() {let { dashboardId } = this.props;if (!dashboardId) {let lastDashboard = null;try {lastDashboard = sessionStorage.getItem(SK_DASHBOARD_ID);} catch (error) {// continue regardless of error\n      }dashboardId = lastDashboard && parseInt(lastDashboard, 10);}if (dashboardId) {try {const result = await this.loadDashboard(dashboardId);if (canUserEditDashboard(result, this.props.user)) {this.setState({ dashboard: { label: result.dashboard_title, value: result.id } });}} catch (error) {logging.warn(error);this.props.addDangerToast(t('An error occurred while loading dashboard information.'));}}}onSliceNameChange(event) {this.setState({ newSliceName: event.target.value });}onDashboardChange(dashboard) {this.setState({ dashboard });}changeAction(action) {this.setState({ action });}onHide() {this.props.dispatch(setSaveChartModalVisibility(false));}async saveOrOverwrite(gotodash) {this.setState({ isLoading: true });try {var _this$props$datasourc4;if (((_this$props$datasourc4 = this.props.datasource) == null ? void 0 : _this$props$datasourc4.type) === DatasourceType.Query) {const { schema, sql, database } = this.props.datasource;const { templateParams } = this.props.datasource;await this.props.actions.saveDataset({ schema, sql, database, templateParams, datasourceName: this.state.datasetName });} //  Get chart dashboards\n      let sliceDashboards = [];if (this.props.slice && this.state.action === 'overwrite') {sliceDashboards = await this.props.actions.getSliceDashboards(this.props.slice);}const formData = this.props.form_data || {};delete formData.url_params;let dashboard = null;if (this.state.dashboard) {var _dashboard;let validId = this.state.dashboard.value;if (this.isNewDashboard()) {const response = await this.props.actions.createDashboard(this.state.dashboard.label);validId = response.id;}try {dashboard = await this.loadDashboard(validId);} catch (error) {this.props.actions.saveSliceFailed();return;}if (isDefined(dashboard) && isDefined((_dashboard = dashboard) == null ? void 0 : _dashboard.id)) {sliceDashboards = sliceDashboards.includes(dashboard.id) ? sliceDashboards : [...sliceDashboards, dashboard.id];formData.dashboards = sliceDashboards;}} // Sets the form data\n      this.props.actions.setFormData({ ...formData }); //  Update or create slice\n      let value;if (this.state.action === 'overwrite') {value = await this.props.actions.updateSlice(this.props.slice, this.state.newSliceName, sliceDashboards, dashboard ? { title: dashboard.dashboard_title, new: this.isNewDashboard() } : null);} else {value = await this.props.actions.createSlice(this.state.newSliceName, sliceDashboards, dashboard ? { title: dashboard.dashboard_title, new: this.isNewDashboard() } : null);}try {if (dashboard) {sessionStorage.setItem(SK_DASHBOARD_ID, `${dashboard.id}`);} else {sessionStorage.removeItem(SK_DASHBOARD_ID);}} catch (error) {// continue regardless of error\n      } // Go to new dashboard url\n      if (gotodash && dashboard) {this.props.history.push(dashboard.url);return;}const searchParams = this.handleRedirect(window.location.search, value);this.props.history.replace(`/explore/?${searchParams.toString()}`);this.setState({ isLoading: false });this.onHide();} finally {this.setState({ isLoading: false });}}render() {return _jsx(StyledModal, { show: this.props.isVisible, onHide: this.onHide, title: t('Save chart'), footer: this.renderFooter(), children: this.state.isLoading ? _jsx(\"div\", { css: css`\n              display: flex;\n              justify-content: center;\n            `, children: _jsx(Loading, { position: \"normal\" }) }) : this.renderSaveChartModal() });\n  }\n}\nfunction mapStateToProps({ explore, saveModal, user }) {\n  return {\n    datasource: explore.datasource,\n    slice: explore.slice,\n    user,\n    dashboards: saveModal.dashboards,\n    alert: saveModal.saveModalAlert,\n    isVisible: saveModal.isVisible\n  };\n}\nexport default withRouter(connect(mapStateToProps)(SaveModal));\n// User for testing purposes need to revisit once we convert this to functional component\nexport { SaveModal as PureSaveModal };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}