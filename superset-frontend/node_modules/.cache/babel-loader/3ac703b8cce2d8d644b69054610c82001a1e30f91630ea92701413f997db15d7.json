{"ast":null,"code":"/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport { useEffect, useRef } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { reRunQuery } from 'src/SqlLab/actions/sqlLab';\nimport { triggerQuery } from 'src/components/Chart/chartAction';\nimport { onRefresh } from 'src/dashboard/actions/dashboardState';\nimport { t } from '@superset-ui/core';\nimport ErrorAlert from './ErrorAlert';\n/*\n * Component for starting OAuth2 dance.\n *\n * When a user without credentials tries to access a database that supports OAuth2, the\n * backend will raise an exception with the custom error `OAUTH2_REDIRECT`. This will\n * cause the frontend to display this component, which informs the user that they need\n * to authenticate in order to access the data.\n *\n * The component has a URL that is used to start the OAuth2 dance for the given\n * database. When the user clicks the link a new browser tab will open, where they can\n * authorize Superset to access the data. Once authorization is successful the user will\n * be redirected back to Superset, and their personal access token is stored, so it can\n * be used in subsequent connections. If a refresh token is also present in the response,\n * it will also be stored.\n *\n * After the token has been stored, the opened tab will send a message to the original\n * tab and close itself. This component, running on the original tab, will listen for\n * message events, and once it receives the success message from the opened tab it will\n * re-run the query for the user, be it in SQL Lab, Explore, or a dashboard. In order to\n * communicate securely, both tabs share a \"tab ID\", which is a UUID that is generated\n * by the backend and sent from the opened tab to the original tab. For extra security,\n * we also check that the source of the message is the opened tab via a ref.\n */import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from \"@emotion/react/jsx-runtime\";\nfunction OAuth2RedirectMessage({ error, source }) {\n  const oAuthTab = useRef(null);\n  const { extra, level } = error;\n  // store a reference to the OAuth2 browser tab, so we can check that the success\n  // message is coming from it\n  const handleOAuthClick = (event) => {\n    event.preventDefault();\n    oAuthTab.current = window.open(extra.url, '_blank');\n  };\n  // state needed for re-running the SQL Lab query\n  const queries = useSelector((state) => state.sqlLab.queries);\n  const queryEditors = useSelector((state) => state.sqlLab.queryEditors);\n  const tabHistory = useSelector((state) => state.sqlLab.tabHistory);\n  const qe = queryEditors.find((qe) => qe.id === tabHistory[tabHistory.length - 1]);\n  const query = qe != null && qe.latestQueryId ? queries[qe.latestQueryId] : null;\n  // state needed for triggering the chart in Explore\n  const chartId = useSelector((state) => {var _state$explore, _state$explore$slice;return (_state$explore = state.explore) == null ? void 0 : (_state$explore$slice = _state$explore.slice) == null ? void 0 : _state$explore$slice.slice_id;});\n  // state needed for refreshing dashboard\n  const chartList = useSelector((state) => Object.keys(state.charts));\n  const dashboardId = useSelector((state) => {var _state$dashboardInfo;return (_state$dashboardInfo = state.dashboardInfo) == null ? void 0 : _state$dashboardInfo.id;});\n  const dispatch = useDispatch();\n  useEffect(() => {\n    /* Listen for messages from the OAuth2 tab.\n     *\n     * After OAuth2 is successful the opened tab will send a message before\n     * closing itself. Once we receive the message we can retrigger the\n     * original query in SQL Lab, explore, or in a dashboard.\n     */\n    const redirectUrl = new URL(extra.redirect_uri);\n    const handleMessage = (event) => {\n      if (event.origin === redirectUrl.origin &&\n      event.data.tabId === extra.tab_id &&\n      event.source === oAuthTab.current) {\n        if (source === 'sqllab' && query) {\n          dispatch(reRunQuery(query));\n        } else\n        if (source === 'explore' && chartId) {\n          dispatch(triggerQuery(true, chartId));\n        } else\n        if (source === 'dashboard') {\n          dispatch(onRefresh(chartList, true, 0, dashboardId));\n        }\n      }\n    };\n    window.addEventListener('message', handleMessage);\n    return () => {\n      window.removeEventListener('message', handleMessage);\n    };\n  }, [\n  source,\n  extra.redirect_uri,\n  extra.tab_id,\n  dispatch,\n  query,\n  chartId,\n  chartList,\n  dashboardId]\n  );\n  const body = _jsx(\"p\", { children: \"This database uses OAuth2 for authentication. Please click the link above to grant Apache Superset permission to access the data. Your personal access token will be stored encrypted and used only for queries run by you.\" }\n\n\n\n\n  );\n  const subtitle = _jsxs(_Fragment, { children: [\"You need to\",\n    ' ',\n    _jsx(\"a\", { href: extra.url, onClick: handleOAuthClick, target: \"_blank\", rel: \"noreferrer\", children: \"provide authorization\" }\n\n    ), ' ', \"in order to run this operation.\"] }\n\n  );\n  return _jsx(ErrorAlert, { errorType: t('Authorization needed'), message: subtitle, type: level, description: body });\n}\nexport default OAuth2RedirectMessage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}